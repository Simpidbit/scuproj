后端有两个进程：

- 进程A负责：
  - 处理HTTP请求并将请求相关的数据解析出来，发给进程B.
  - 接收进程B的处理结果，并将处理结果反馈给前端.
- 进程B负责：
  - 处理具体的管理课程逻辑和选择课程逻辑，并将数据写入数据库.

进程A与B之间通过本地回环网络（127.0.0.1）进行数据交换，此文档定义了A和B之间交互数据的格式.

交互数据是字节流.

0idx、1idx、2idx分别表示交互数据（字节流）的第1个字节、第2个字节、第3个字节，以此类推.

位置在0idx的一个字节表示交互数据在业务逻辑方面的类型，例如可以表示登录请求、选课请求等类型.



表0:

| 0 idx (type) 的值 | 类型 | 后续数据格式 |
| -------- | ----- | ------------ |
| 0        |登录请求| 见表1 |
| 1 |登录结果| 见表2 |
| 2 |修改密码请求| 见表3 |
| 3 |修改密码结果| 见表4 |
| 4 |增加课程请求| 见表5 |
| 5 |增加课程结果| 见表6 |
| 6 |选择课程请求| 见表7 |
| 7 |选择课程结果| 见表8 |
| 8 |查询单个课程信息| 见表9 |
| 9 |查询单个课程信息的结果| 见表10 |
| 10 |退课请求| 见表11 |
| 11 |退课结果| 见表12 |



表1:  登录请求

| 字节流位置 | 含义 | 示例 |
| ---------- | ---- | --- |
| 1 idx      | account_level | `0`，表示登录账户身份是学生 |
| 2~9 idx (8 bytes) | account_id | `"91025322"` |
| 10~73 idx (64 bytes) | account_passwd | 略 |



表2:  登录结果

| 字节流位置 | 含义                                                         |
| ---------- | ------------------------------------------------------------ |
| 1 idx      | result，是否成功登录，0表示成功，1表示账号不存在，2表示账号存在但密码错误，3表示账号、密码都正确，但权限错误. |
| 2~65 idx   | token，此段数据仅当成功登录时才存在，是服务端返回的身份证明. |






表3:  修改密码请求

| 字节流位置 | 含义           | 示例         |
| ---------- | -------------- | ------------ |
| 1～8 idx   | account_id     | `"29015932"` |
| 9~72 idx   | account_passwd | 略           |
| 73~136 idx | token          | 略           |




表4:  修改密码结果

| 字节流位置 | 含义                                            |
| ---------- | ----------------------------------------------- |
| 1 idx      | result，是否成功修改密码，0表示成功，1表示失败. |



表5:  增加课程请求

此请求仅可由管理员账户 (account_level = 1) 发起.

| 字节流位置                    | 含义                                            | 示例                                                         |
| ----------------------------- | ----------------------------------------------- | ------------------------------------------------------------ |
| 1~8 idx                       | account_id                                      | `"51029302"`                                                 |
| 9~72 idx                      | token                                           | 略                                                           |
| 73~82 idx                     | course_id                                       | `"8291038923"`                                               |
| 83 idx                        | course_name_len，course_name 所占字节数 (记为N) | `8`                                                          |
| 84~84+N-1 idx                 | course_name                                     | `"Calculus"`                                                 |
| 84+N~84+N+1 idx (2 bytes)     | course_capacity                                 | `192`                                                        |
| 84+N+2~84+N+3 idx (2 bytes)   | course_spare                                    | `100`                                                        |
| 84+N+4~84+N+w+3 idx (w bytes) | course_week                                     | `b"\x05\x01\x03\x05\x0a"`表示第1~3周和第5~10周上课           |
| 84+N+w+4~84+N+w+d+3 (d bytes) | course_day                                      | `b"\x03\x01\x01\x03\x03\x05\x07\x05\x02\x03"`表示每周的周一的1~3节、周三的5~7节、周五的2~3节上课 |

:warning: 注意：上表中的 course_capacity 和 course_spare 是两字节的整型，在内存布局上：采用小端序，低字节在低地址.



表6:  增加课程结果

| 字节流位置 | 含义                                                         |
| ---------- | ------------------------------------------------------------ |
| 1 idx      | result，0 表示成功，1 表示 course_id 与已存在的课程冲突，2 表示其他失败 |



表7:  选择课程请求

此请求仅可由学生账户 (account_level = 0) 发起.

| 字节流位置 | 含义 | 示例 |
| ---------- | ---- | ---|
| 1~8 idx | account_id | `"51029302"` |
| 9~72 idx | token | 略 |
| 73~82 idx | course_id | `"8291038923"` |





表8:  选择课程结果

| 字节流位置 | 含义                                                         |
| ---------- | ------------------------------------------------------------ |
| 1 idx      | result，0 表示成功，其他值表示失败（具体失败原因对应于不同的值，待定） |



表9:  查询单个课程信息

| 字节流位置 | 含义      | 示例           |
| ---------- | --------- | -------------- |
| 1~10 idx   | course_id | `"8291038923"` |



表10:  查询单个课程信息的结果

| 字节流位置                        | 含义                                   | 示例               |
| --------------------------------- | -------------------------------------- | ------------------ |
| 1~10 idx                          | course_id                              | `"8291038923"`     |
| 11 idx                            | course_name_len，course_name所占字节数 | `14`               |
| 12~12+N-1 idx                     | course_name                            | `"Linear Algebra"` |
| 12+N~12+N+1 idx                   | course_capacity                        | `192`              |
| 12+N+2~12+N+3 idx                 | course_spare                           | `100`              |
| 12+N+4~12+N+w+3 idx (w bytes)     | course_week                            | 略                 |
| 12+N+w+4~12+N+w+d+3 idx (d bytes) | course_day                             | 略                 |



表11:  退课请求

| 字节流位置 | 含义       |
| ---------- | ---------- |
| 1~8 idx    | account_id |
| 9~72 idx   | token      |
| 73~82 idx  | course_id  |



表12:  退课结果

| 字节流位置 | 含义                           |
| ---------- | ------------------------------ |
| 1 idx      | result，0 表示成功，1 表示失败 |



附：不同字段数据在C++解析时的数据类型（字典序排列下表）

| 字段名          | 数据类型                     |
| --------------- | ---------------------------- |
| account_id      | `std::string`                |
| account_level   | `unsigned char`              |
| account_passwd  | `std::string`                |
| course_capacity | `unsigned int`               |
| course_day      | `std::vector<unsigned char>` |
| course_id       | `std::string`                |
| course_name     | `std::string`                |
| course_name_len | `unsigned char`              |
| course_spare    | `unsigned int`               |
| course_week     | `std::vector<unsigned char>` |
| result          | `unsigned char`              |
| token           | `std::string`                |
| type            | `unsigned char`              |

